<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Step 3: Refinement • recolorize</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Step 3: Refinement">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">recolorize</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/step00_prep.html">Step 0: Image acquisition and preparation</a></li>
    <li><a class="dropdown-item" href="../articles/step01_loading.html">Step 1: Loading &amp; processing images</a></li>
    <li><a class="dropdown-item" href="../articles/step02_initial_cluster.html">Step 2: Initial clustering</a></li>
    <li><a class="dropdown-item" href="../articles/step03_refinement.html">Step 3: Refinement</a></li>
    <li><a class="dropdown-item" href="../articles/step04_manual_tweak.html">Step 4: Tweaks &amp; edits</a></li>
    <li><a class="dropdown-item" href="../articles/step05_visualization_export.html">Step 5: Exporting &amp; visualizing output</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hiweller/recolorize/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Step 3: Refinement</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hiweller/recolorize/blob/master/vignettes/step03_refinement.Rmd" class="external-link"><code>vignettes/step03_refinement.Rmd</code></a></small>
      <div class="d-none name"><code>step03_refinement.Rmd</code></div>
    </div>

    
    
<blockquote>
<p>Using simple rules to improve the initial results.</p>
</blockquote>
<ul>
<li>
<a href="Introduction.html">Introduction</a><br>
</li>
<li>
<a href="step00_prep.html">Step 0: Image acquisition and
preparation</a><br>
</li>
<li>
<a href="step01_loading.html">Step 1: Loading &amp; processing
images</a><br>
</li>
<li>
<a href="step02_initial_cluster.html">Step 2: Initial
clustering</a><br>
</li>
<li>Step 3: Refinement</li>
<li>
<a href="step04_manual_tweak.html">Step 4: Tweaks &amp;
edits</a><br>
</li>
<li><a href="step05_visualization_export.html">Step 5: Visualizing &amp;
exporting output</a></li>
</ul>
<blockquote>
<p>You can also tour the functions in the <a href="https://hiweller.rbind.io/post/function-gallery-for-recolorize/" class="external-link">function
gallery</a>.</p>
</blockquote>
<p>Once we’ve reduced an image down to a tractable number of colors, we
can define simple procedures for how to combine them based on
similarity. <code>recolorize</code> (currently) comes with two of these:
<code>recluster</code>, which merges colors by perceived similarity, and
<code>thresholdRecolor</code>, which drops minor colors. Both are
simple, but surprisingly effective. They’re also built on top of some
really simple functions we’ll see in a bit, so if you need to, you can
build out a similar procedure tailored to your dataset—for example,
combining layers based only on their brightness values, or only
combining green layers.</p>
<div class="section level3">
<h3 id="recluster-and-recolorize2">
<code>recluster()</code> and <code>recolorize2()</code><a class="anchor" aria-label="anchor" href="#recluster-and-recolorize2"></a>
</h3>
<p>This is the one I use the most often, and its implementation is
really simple. This function calculates the Euclidean distances between
all the color centers in a recolorize object, clusters them
hierarchically using <code>hclust</code>, then uses a user-specified
cutoff to combine the most similar colors. As with
<code>recolorize</code>, you can choose your color space, and that will
make a big difference. Let’s see this in action:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hiweller.github.io/recolorize/">recolorize</a></span><span class="op">)</span></span>
<span><span class="va">corbetti</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/corbetti.png"</span>, package <span class="op">=</span> <span class="st">"recolorize"</span><span class="op">)</span></span>
<span><span class="va">init_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recolorize.html">recolorize</a></span><span class="op">(</span><span class="va">corbetti</span>, plotting <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Using 2^3 = 8 total bins</span></span>
<span><span class="va">recluster_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recluster.html">recluster</a></span><span class="op">(</span><span class="va">init_fit</span>, </span>
<span>                               cutoff <span class="op">=</span> <span class="fl">45</span><span class="op">)</span></span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-3-1.png" width="384" style="display: block; margin: auto;"><img src="step03_refinement_files/figure-html/unnamed-chunk-3-2.png" width="384" style="display: block; margin: auto;"></p>
<p>Notice the color dendrogram: it lumped together clusters 4 &amp; 7,
clusters 3 &amp; 5, and clusters 6 &amp; 8, because their distance was
less than 45. This is in CIE Lab space; if we use RGB space, the range
of distances is 0-1:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recluster_rgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recluster.html">recluster</a></span><span class="op">(</span><span class="va">init_fit</span>, color_space <span class="op">=</span> <span class="st">"sRGB"</span>,</span>
<span>                           cutoff <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-4-1.png" width="384" style="display: block; margin: auto;"><img src="step03_refinement_files/figure-html/unnamed-chunk-4-2.png" width="384" style="display: block; margin: auto;"></p>
<p>In this case, we get the same results, but this is always worth
playing around with. Despite its simplicity, this function is highly
effective at producing intuitive results. This is partly because, in
only using color similarity to combine clusters, it does not penalize
smaller color clusters that can still retain important details. Because
of its utility (and speed), I included a wrapper function,
<code>recolorize2</code>, to run <code>recolorize</code> and
<code>recluster</code> sequentially in a single step:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># let's use a different image:</span></span>
<span><span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/chongi.png"</span>, package <span class="op">=</span> <span class="st">"recolorize"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is identical to running:</span></span>
<span><span class="co"># fit1 &lt;- recolorize(img, bins = 3)</span></span>
<span><span class="co"># fit2 &lt;- recluster(fit1, cutoff = 50)</span></span>
<span><span class="va">chongi_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recolorize2.html">recolorize2</a></span><span class="op">(</span><span class="va">img</span>, bins <span class="op">=</span> <span class="fl">3</span>, cutoff <span class="op">=</span> <span class="fl">45</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Using 3^3 = 27 total bins</span></span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-5-1.png" width="480" style="display: block; margin: auto;"><img src="step03_refinement_files/figure-html/unnamed-chunk-5-2.png" width="480" style="display: block; margin: auto;"></p>
<p>There’s also a lot of room for modification here: this is a pretty
unsophisticated rule for combining color clusters (ignoring, for
example, cluster size, proximity, geometry, and boundary strength), but
it’s pretty simple to write better rules if you can think of them,
because the functions that are called to implement this are also
exported by the package.</p>
</div>
<div class="section level3">
<h3 id="thresholdrecolor">
<code>thresholdRecolor()</code><a class="anchor" aria-label="anchor" href="#thresholdrecolor"></a>
</h3>
<p>An even simpler rule: drop the smallest color clusters whose
cumulative sum (as a proportion of total pixels assigned) is lower than
some threshold, like 5% of the image. I thought this would be too simple
to be useful, but every once in a while it’s just the thing, especially
if you always end up with weird spurious details.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chongi_threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thresholdRecolor.html">thresholdRecolor</a></span><span class="op">(</span><span class="va">chongi_fit</span>, pct <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="step03_refinement_files/figure-html/unnamed-chunk-6-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hannah Weller.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
